{% extends "admin/base_site.html" %}
{% load static %}

{% block title %}Tournament {{ tournament.id }} Monitoring{% endblock %}

{% block extrahead %}
<style>
    .monitoring-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin: 20px 0;
    }
    
    .monitoring-card {
        background: white;
        border: 1px solid #ddd;
        border-radius: 8px;
        padding: 20px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .full-width {
        grid-column: 1 / -1;
    }
    
    .status-healthy { color: #28a745; }
    .status-warning { color: #ffc107; }
    .status-critical { color: #dc3545; }
    
    .log-entry {
        padding: 8px;
        margin: 4px 0;
        border-left: 4px solid #ddd;
        background: #f8f9fa;
        font-family: monospace;
        font-size: 12px;
    }
    
    .log-automation_start { border-left-color: #007bff; }
    .log-decision { border-left-color: #6c757d; }
    .log-action { border-left-color: #28a745; }
    .log-error { border-left-color: #dc3545; background: #fff5f5; }
    .log-success { border-left-color: #28a745; }
    .log-status_change { border-left-color: #ffc107; }
    
    .structure-table {
        width: 100%;
        border-collapse: collapse;
        margin: 10px 0;
    }
    
    .structure-table th,
    .structure-table td {
        border: 1px solid #ddd;
        padding: 8px;
        text-align: left;
    }
    
    .structure-table th {
        background: #f8f9fa;
    }
    
    .control-panel {
        background: #f8f9fa;
        padding: 15px;
        border-radius: 4px;
        margin: 15px 0;
    }
    
    .control-btn {
        background: #007bff;
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 4px;
        cursor: pointer;
        margin: 5px;
    }
    
    .control-btn.success { background: #28a745; }
    .control-btn.warning { background: #ffc107; color: #000; }
    .control-btn.danger { background: #dc3545; }
    
    .error-details {
        background: #fff5f5;
        border: 1px solid #f5c6cb;
        padding: 10px;
        margin: 5px 0;
        border-radius: 4px;
        font-family: monospace;
        font-size: 11px;
    }
    
    .tabs {
        display: flex;
        border-bottom: 1px solid #ddd;
        margin-bottom: 15px;
    }
    
    .tab {
        padding: 10px 20px;
        cursor: pointer;
        border-bottom: 2px solid transparent;
    }
    
    .tab.active {
        border-bottom-color: #007bff;
        background: #f8f9fa;
    }
    
    .tab-content {
        display: none;
    }
    
    .tab-content.active {
        display: block;
    }
    
    .real-time-indicator {
        position: fixed;
        top: 10px;
        right: 10px;
        background: rgba(0,0,0,0.8);
        color: white;
        padding: 10px;
        border-radius: 4px;
        font-size: 12px;
    }
    
    .real-time-indicator.connected {
        background: rgba(40, 167, 69, 0.8);
    }
</style>
{% endblock %}

{% block content %}
<div class="real-time-indicator" id="realTimeIndicator">
    üî¥ Monitoring: Tournament {{ tournament.id }}
</div>

<h1>Tournament {{ tournament.id }}: {{ tournament.name }}</h1>

<div class="control-panel">
    <h3>Automation Controls</h3>
    <button class="control-btn" onclick="controlAutomation('reset_status')">Reset Status</button>
    <button class="control-btn success" onclick="controlAutomation('trigger_automation')">Trigger Automation</button>
    <button class="control-btn warning" onclick="controlAutomation('generate_round')">Generate Round</button>
    <button class="control-btn warning" onclick="controlAutomation('advance_stage')">Advance Stage</button>
    <button class="control-btn" onclick="refreshAll()">Refresh All</button>
    <button class="control-btn" onclick="exportTournamentLogs()">Export Logs</button>
</div>

<div class="monitoring-grid">
    <div class="monitoring-card">
        <h2>Tournament Status</h2>
        <div id="tournamentStatus">
            <p><strong>Status:</strong> <span class="status-{{ status.health_status }}">{{ status.automation_status }}</span></p>
            <p><strong>Current Round:</strong> {{ status.current_round }}</p>
            <p><strong>Active:</strong> {{ status.is_active|yesno:"Yes,No" }}</p>
            <p><strong>Last Automation:</strong> {{ status.last_automation|default:"Never" }}</p>
            <p><strong>Recent Errors:</strong> <span class="status-{% if status.recent_errors == 0 %}healthy{% elif status.recent_errors < 3 %}warning{% else %}critical{% endif %}">{{ status.recent_errors }}</span></p>
            <p><strong>Health:</strong> <span class="status-{{ status.health_status }}">{{ status.health_status|upper }}</span></p>
        </div>
    </div>
    
    <div class="monitoring-card">
        <h2>Log Statistics</h2>
        <div id="logStats">
            {% for stat in log_stats %}
            <p><strong>{{ stat.event_type|title }}:</strong> {{ stat.count }}</p>
            {% endfor %}
        </div>
    </div>
    
    <div class="monitoring-card">
        <h2>Tournament Structure</h2>
        
        <h4>Stages</h4>
        <table class="structure-table">
            <thead>
                <tr>
                    <th>Stage</th>
                    <th>Name</th>
                    <th>Format</th>
                    <th>Rounds</th>
                    <th>Qualifiers</th>
                </tr>
            </thead>
            <tbody>
                {% for stage in stages %}
                <tr>
                    <td>{{ stage.stage_number }}</td>
                    <td>{{ stage.name }}</td>
                    <td>{{ stage.format }}</td>
                    <td>{{ stage.num_rounds_in_stage }}</td>
                    <td>{{ stage.num_qualifiers }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        
        <h4>Rounds</h4>
        <table class="structure-table">
            <thead>
                <tr>
                    <th>Round</th>
                    <th>Stage</th>
                    <th>Complete</th>
                </tr>
            </thead>
            <tbody>
                {% for round in rounds %}
                <tr>
                    <td>{{ round.number }}</td>
                    <td>{{ round.stage.stage_number }} ({{ round.stage.name }})</td>
                    <td>{{ round.is_complete|yesno:"‚úÖ,‚è≥" }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    
    <div class="monitoring-card">
        <h2>Recent Matches</h2>
        <table class="structure-table">
            <thead>
                <tr>
                    <th>Match</th>
                    <th>Teams</th>
                    <th>Status</th>
                    <th>Round</th>
                </tr>
            </thead>
            <tbody>
                {% for match in matches %}
                <tr>
                    <td>{{ match.id }}</td>
                    <td>{{ match.team1 }} vs {{ match.team2 }}</td>
                    <td>{{ match.status }}</td>
                    <td>{{ match.round_number|default:"N/A" }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<div class="monitoring-card full-width">
    <h2>Automation Logs</h2>
    
    <div class="tabs">
        <div class="tab active" onclick="switchTab('all-logs')">All Logs</div>
        <div class="tab" onclick="switchTab('errors-only')">Errors Only</div>
        <div class="tab" onclick="switchTab('decisions')">Decisions</div>
        <div class="tab" onclick="switchTab('actions')">Actions</div>
    </div>
    
    <div id="all-logs" class="tab-content active">
        <div id="allLogsList" style="max-height: 500px; overflow-y: auto;">
            {% for log in logs %}
            <div class="log-entry log-{{ log.event_type }}">
                <div style="display: flex; justify-content: space-between;">
                    <strong>{{ log.event_type|upper }}</strong>
                    <small>{{ log.timestamp|date:"Y-m-d H:i:s" }}</small>
                </div>
                <div>{{ log.message }}</div>
                {% if log.details %}
                <div><strong>Details:</strong> {{ log.details }}</div>
                {% endif %}
                {% if log.reasoning %}
                <div><strong>Reasoning:</strong> {{ log.reasoning }}</div>
                {% endif %}
                {% if log.context %}
                <div><strong>Context:</strong> {{ log.context }}</div>
                {% endif %}
                {% if log.event_type == 'error' and log.data.traceback %}
                <div class="error-details">
                    <strong>Traceback:</strong><br>
                    {{ log.data.traceback|linebreaks }}
                </div>
                {% endif %}
            </div>
            {% endfor %}
        </div>
    </div>
    
    <div id="errors-only" class="tab-content">
        <div style="max-height: 500px; overflow-y: auto;">
            {% for error in recent_errors %}
            <div class="log-entry log-error">
                <div style="display: flex; justify-content: space-between;">
                    <strong>ERROR</strong>
                    <small>{{ error.timestamp|date:"Y-m-d H:i:s" }}</small>
                </div>
                <div>{{ error.message }}</div>
                {% if error.context %}
                <div><strong>Context:</strong> {{ error.context }}</div>
                {% endif %}
                {% if error.data.traceback %}
                <div class="error-details">
                    <strong>Traceback:</strong><br>
                    {{ error.data.traceback|linebreaks }}
                </div>
                {% endif %}
            </div>
            {% endfor %}
        </div>
    </div>
    
    <div id="decisions" class="tab-content">
        <div style="max-height: 500px; overflow-y: auto;">
            {% for log in logs %}
            {% if log.event_type == 'decision' %}
            <div class="log-entry log-decision">
                <div style="display: flex; justify-content: space-between;">
                    <strong>DECISION</strong>
                    <small>{{ log.timestamp|date:"Y-m-d H:i:s" }}</small>
                </div>
                <div>{{ log.message }}</div>
                {% if log.reasoning %}
                <div><strong>Reasoning:</strong> {{ log.reasoning }}</div>
                {% endif %}
            </div>
            {% endif %}
            {% endfor %}
        </div>
    </div>
    
    <div id="actions" class="tab-content">
        <div style="max-height: 500px; overflow-y: auto;">
            {% for log in logs %}
            {% if log.event_type == 'action' %}
            <div class="log-entry log-action">
                <div style="display: flex; justify-content: space-between;">
                    <strong>ACTION</strong>
                    <small>{{ log.timestamp|date:"Y-m-d H:i:s" }}</small>
                </div>
                <div>{{ log.message }}</div>
                {% if log.details %}
                <div><strong>Details:</strong> {{ log.details }}</div>
                {% endif %}
            </div>
            {% endif %}
            {% endfor %}
        </div>
    </div>
</div>

<script>
let autoRefreshEnabled = true;
let autoRefreshInterval;
let latestLogId = {{ logs.0.id|default:0 }};

// Start auto-refresh
startAutoRefresh();

function startAutoRefresh() {
    if (autoRefreshInterval) clearInterval(autoRefreshInterval);
    
    autoRefreshInterval = setInterval(() => {
        if (autoRefreshEnabled) {
            refreshStatus();
            refreshLogs();
            updateIndicator();
        }
    }, 3000); // Refresh every 3 seconds
    
    updateIndicator();
}

function updateIndicator() {
    const indicator = document.getElementById('realTimeIndicator');
    if (autoRefreshEnabled) {
        indicator.textContent = 'üü¢ Live Monitoring: Tournament {{ tournament.id }}';
        indicator.className = 'real-time-indicator connected';
    } else {
        indicator.textContent = 'üî¥ Monitoring Paused: Tournament {{ tournament.id }}';
        indicator.className = 'real-time-indicator';
    }
}

function refreshStatus() {
    fetch('/tournaments/monitoring/api/status/{{ tournament.id }}/')
        .then(response => response.json())
        .then(data => {
            updateStatusDisplay(data);
        })
        .catch(error => console.error('Error refreshing status:', error));
}

function refreshLogs() {
    fetch(`/tournaments/monitoring/api/logs/{{ tournament.id }}/?since_id=${latestLogId}&limit=10`)
        .then(response => response.json())
        .then(data => {
            if (data.logs.length > 0) {
                updateLogsDisplay(data.logs);
                latestLogId = data.latest_id;
            }
        })
        .catch(error => console.error('Error refreshing logs:', error));
}

function updateStatusDisplay(status) {
    const container = document.getElementById('tournamentStatus');
    const healthClass = status.health_status;
    
    container.innerHTML = `
        <p><strong>Status:</strong> <span class="status-${healthClass}">${status.automation_status}</span></p>
        <p><strong>Current Round:</strong> ${status.current_round}</p>
        <p><strong>Active:</strong> ${status.is_active ? 'Yes' : 'No'}</p>
        <p><strong>Last Automation:</strong> ${status.last_automation || 'Never'}</p>
        <p><strong>Recent Errors:</strong> <span class="status-${status.recent_errors === 0 ? 'healthy' : status.recent_errors < 3 ? 'warning' : 'critical'}">${status.recent_errors}</span></p>
        <p><strong>Health:</strong> <span class="status-${healthClass}">${status.health_status.toUpperCase()}</span></p>
    `;
}

function updateLogsDisplay(logs) {
    const container = document.getElementById('allLogsList');
    
    // Add new logs to the top
    logs.reverse().forEach(log => {
        const div = document.createElement('div');
        div.className = `log-entry log-${log.event_type}`;
        
        const timestamp = new Date(log.timestamp).toLocaleString();
        
        div.innerHTML = `
            <div style="display: flex; justify-content: space-between;">
                <strong>${log.event_type.toUpperCase()}</strong>
                <small>${timestamp}</small>
            </div>
            <div>${log.message}</div>
            ${log.details ? `<div><strong>Details:</strong> ${log.details}</div>` : ''}
            ${log.reasoning ? `<div><strong>Reasoning:</strong> ${log.reasoning}</div>` : ''}
            ${log.context ? `<div><strong>Context:</strong> ${log.context}</div>` : ''}
        `;
        
        container.insertBefore(div, container.firstChild);
    });
    
    // Keep only the latest 100 entries
    while (container.children.length > 100) {
        container.removeChild(container.lastChild);
    }
}

function switchTab(tabId) {
    // Hide all tab contents
    document.querySelectorAll('.tab-content').forEach(content => {
        content.classList.remove('active');
    });
    
    // Remove active class from all tabs
    document.querySelectorAll('.tab').forEach(tab => {
        tab.classList.remove('active');
    });
    
    // Show selected tab content
    document.getElementById(tabId).classList.add('active');
    
    // Add active class to clicked tab
    event.target.classList.add('active');
}

function controlAutomation(action) {
    const formData = new FormData();
    formData.append('action', action);
    
    fetch('/tournaments/monitoring/control/{{ tournament.id }}/', {
        method: 'POST',
        body: formData,
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(data.message);
            refreshAll();
        } else {
            alert('Error: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error controlling automation:', error);
        alert('Error controlling automation');
    });
}

function refreshAll() {
    location.reload();
}

function exportTournamentLogs() {
    window.open('/tournaments/monitoring/export/{{ tournament.id }}/?format=json', '_blank');
}

// Toggle auto-refresh with spacebar
document.addEventListener('keydown', function(event) {
    if (event.code === 'Space' && event.target.tagName !== 'INPUT') {
        event.preventDefault();
        autoRefreshEnabled = !autoRefreshEnabled;
        updateIndicator();
    }
});
</script>

{% csrf_token %}
{% endblock %}

